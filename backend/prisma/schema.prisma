generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Rol {
  id       Int       @id @default(autoincrement())
  nombre   String    @unique @db.VarChar(50)
  usuarios Usuario[]

  @@map("roles")
}

model Campaña {
  id       Int       @id @default(autoincrement())
  nombre   String    @unique @db.VarChar(100)
  usuarios Usuario[]
  supervisores SupervisorCampaña[]

  @@map("campañas")
}

model Usuario {
  id              Int       @id @default(autoincrement())
  nombreUsuario   String    @unique @map("nombre_usuario") @db.VarChar(50)
  contraseña      String    @db.VarChar(255)
  nombreCompleto  String    @map("nombre_completo") @db.VarChar(100)
  correoElectronico String? @map("correo_electronico") @db.VarChar(100)
  documentoIdentidad String? @map("documento_identidad") @db.VarChar(20)
  estado          Boolean   @default(true)
  fechaCreacion   DateTime  @default(now()) @map("fecha_creacion") @db.Date
  
  rolId           Int       @map("rol_id")
  rol             Rol       @relation(fields: [rolId], references: [id])
  
  campañaId       Int?      @map("campaña_id")
  campaña         Campaña?  @relation(fields: [campañaId], references: [id])
  
  registros       RegistroActividad[]
  passwordResets  PasswordResetToken[]
  supervisorCampañas SupervisorCampaña[]
  horariosLaborales HorarioLaboral[]

  @@index([nombreUsuario])
  @@index([correoElectronico])
  @@index([documentoIdentidad])
  @@index([rolId])
  @@index([campañaId])
  @@index([rolId, campañaId])
  @@map("usuarios")
}

model Actividad {
  id              Int                 @id @default(autoincrement())
  nombreActividad String              @unique @map("nombre_actividad") @db.VarChar(100)
  descripcion     String?
  activo          Boolean             @default(true)
  orden           Int                 @default(0)
  registros       RegistroActividad[]
  subactividades  Subactividad[]

  @@index([activo, orden])
  @@map("actividades")
}

model Subactividad {
  id                 Int                 @id @default(autoincrement())
  actividadId        Int                 @map("actividad_id")
  nombreSubactividad String              @map("nombre_subactividad") @db.VarChar(100)
  descripcion        String?
  activo             Boolean             @default(true)
  orden              Int                 @default(0)
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamp(6)
  registros          RegistroActividad[]
  actividad          Actividad           @relation(fields: [actividadId], references: [id], onDelete: Cascade)

  @@unique([actividadId, nombreSubactividad])
  @@index([actividadId, activo])
  @@map("subactividades")
}

model RegistroActividad {
  id                   Int           @id @default(autoincrement())
  usuarioId            Int           @map("usuario_id")
  actividadId          Int           @map("actividad_id")
  subactividadId       Int?          @map("subactividad_id")
  fecha                DateTime      @db.Date
  horaInicio           DateTime?     @map("hora_inicio") @db.Timestamp(6)
  horaFin              DateTime?     @map("hora_fin") @db.Timestamp(6)
  duracionSeg          Int?          @map("duracion_seg")
  duracionHms          String?       @map("duracion_hms")
  estado               String?       @db.VarChar(50)
  observaciones        String?
  idClienteReferencia  String?       @map("id_cliente_referencia") @db.VarChar(100)
  resumenBreve         String?       @map("resumen_breve") @db.Text
  actividad            Actividad     @relation(fields: [actividadId], references: [id])
  subactividad         Subactividad? @relation(fields: [subactividadId], references: [id])
  usuario              Usuario       @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId, fecha])
  @@index([actividadId])
  @@index([subactividadId])
  @@index([horaFin])
  @@map("registro_actividades")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  usuarioId Int      @map("usuario_id")
  token     String   @unique @db.VarChar(255)
  expiraEn  DateTime @map("expira_en") @db.Timestamp(6)
  usado     Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([token])
  @@index([expiraEn])
  @@map("password_reset_tokens")
}

/// Relación M:N entre Supervisores (usuarios con rol Supervisor) y Campañas
model SupervisorCampaña {
  supervisorId Int @map("supervisor_id")
  campañaId    Int @map("campaña_id")

  supervisor   Usuario @relation(fields: [supervisorId], references: [id], onDelete: Cascade)
  campaña      Campaña @relation(fields: [campañaId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@id([supervisorId, campañaId])
  @@index([campañaId])
  @@map("supervisor_campañas")
}

/// Configuración de horarios laborales por usuario
/// Soporta tres modalidades:
/// 1. Semanal (tipoHorario='semanal'): Horario fijo por día de semana (diaSemana 1-7)
/// 2. Mensual (tipoHorario='mensual'): Horarios variables cada mes (fechaEspecifica con día del mes)
/// 3. Diario (tipoHorario='diario'): Horarios únicos por fecha específica
model HorarioLaboral {
  id            Int      @id @default(autoincrement())
  usuarioId     Int      @map("usuario_id")
  tipoHorario   String   @default("semanal") @map("tipo_horario") @db.VarChar(20) // 'semanal' | 'mensual' | 'diario'
  diaSemana     Int?     @map("dia_semana") // 1-7 (Lunes-Domingo) - Usado en 'semanal'
  fechaEspecifica DateTime? @map("fecha_especifica") @db.Date // Usado en 'mensual' (solo día-mes) o 'diario' (fecha completa)
  horaInicio    String   @map("hora_inicio") @db.VarChar(5) // HH:MM formato 24h
  horaFin       String   @map("hora_fin") @db.VarChar(5) // HH:MM formato 24h
  horasObjetivo Decimal  @map("horas_objetivo") @db.Decimal(4, 2) // Ej: 8.00, 8.50
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, tipoHorario, diaSemana, fechaEspecifica], name: "unique_horario_config")
  @@index([usuarioId])
  @@index([activo])
  @@index([tipoHorario])
  @@index([fechaEspecifica])
  @@map("horarios_laborales")
}
